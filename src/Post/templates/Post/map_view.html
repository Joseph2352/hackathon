{% extends 'hackathon/base.html' %}
{% load static %}

{% block title %}Carte des Signalements{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden">
        <!-- En-tête -->
        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
            <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Carte des Signalements</h1>
            <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                Visualisez tous les signalements sur la carte de Paris.
            </p>
        </div>

        <!-- Carte -->
        <div id="map" class="h-[600px] w-full"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialiser la carte centrée sur Paris
        const map = L.map('map').setView([48.8566, 2.3522], 13);
        
        // Ajouter le fond de carte
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        // Récupérer les données des posts
        const posts = JSON.parse('{{ posts_data|safe }}');
        
        // Définir les icônes pour chaque catégorie
        const categoryIcons = {
            'infrastructure': L.divIcon({
                className: 'custom-div-icon',
                html: '<div class="bg-blue-500 text-white rounded-full p-2"><i class="fas fa-road"></i></div>',
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            }),
            'securite': L.divIcon({
                className: 'custom-div-icon',
                html: '<div class="bg-red-500 text-white rounded-full p-2"><i class="fas fa-shield-alt"></i></div>',
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            }),
            'environnement': L.divIcon({
                className: 'custom-div-icon',
                html: '<div class="bg-green-500 text-white rounded-full p-2"><i class="fas fa-leaf"></i></div>',
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            }),
            'autre': L.divIcon({
                className: 'custom-div-icon',
                html: '<div class="bg-gray-500 text-white rounded-full p-2"><i class="fas fa-info"></i></div>',
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            })
        };

        // Ajouter les marqueurs pour chaque post
        posts.forEach(post => {
            const marker = L.marker([post.latitude, post.longitude], {
                icon: categoryIcons[post.category] || categoryIcons['autre']
            }).addTo(map);

            // Créer le contenu du popup
            const popupContent = `
                <div class="p-2">
                    <h3 class="font-bold text-lg mb-2">${post.title}</h3>
                    <p class="text-sm mb-2">${post.description}</p>
                    <div class="text-xs text-gray-500">
                        <p>Catégorie: ${post.category}</p>
                        <p>Statut: ${post.status}</p>
                        <p>Date: ${post.created_at}</p>
                    </div>
                    <a href="/post/${post.id}/" class="text-indigo-600 hover:text-indigo-800 text-sm mt-2 inline-block">
                        Voir les détails
                    </a>
                </div>
            `;

            marker.bindPopup(popupContent);
        });
    });
</script>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<style>
    #map {
        z-index: 1;
    }
    .custom-div-icon {
        background: none;
        border: none;
    }
    .custom-div-icon div {
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
</style>
{% endblock %} 